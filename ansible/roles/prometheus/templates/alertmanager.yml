# AlertManager Configuration for EKS Multi-Service Environment
# 실무 운영을 위한 계층적 알림 설정

global:
  # SMTP 기본 설정 (이메일 발송용)
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@dev-cluster.local'
  smtp_auth_username: 'alerts@dev-cluster.local'
  smtp_auth_password: 'change-me' # Vault로 암호화 필요

  # Slack API URL (전역 설정)
  slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

# 알림 라우팅 규칙
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 5m
  repeat_interval: 2h
  receiver: 'web.hook.default'

  # 계층별 라우팅 규칙
  routes:
    # P0: 클러스터 인프라 장애 (즉시 알림)
    - match:
        severity: critical
        category: infrastructure
      receiver: 'infrastructure-critical'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 5m

    # P1: 핵심 애플리케이션 서비스 장애
    - match:
        severity: critical
        category: application
      receiver: 'application-critical'
      group_wait: 30s
      group_interval: 2m
      repeat_interval: 10m

    # P2: 리소스 임계값 경고
    - match:
        severity: warning
        category: resource
      receiver: 'resource-warning'
      group_wait: 5m
      group_interval: 10m
      repeat_interval: 1h

    # P3: 성능 및 용량 주의사항
    - match:
        severity: info
        category: performance
      receiver: 'performance-info'
      group_wait: 15m
      group_interval: 30m
      repeat_interval: 6h

# 알림 수신자 설정
receivers:
  # 기본 수신자 (웹훅 또는 로그)
  - name: 'web.hook.default'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        send_resolved: true

  # P0: 인프라 크리티컬 (SMS + Slack + Email)
  - name: 'infrastructure-critical'
    slack_configs:
      - api_url: '{{ .GlobalSlackAPIURL }}'
        channel: '#ops-critical'
        username: 'AlertManager'
        icon_emoji: ':fire:'
        title: '🚨 [P0-CRITICAL] EKS 클러스터 인프라 장애'
        text: >-
          *알림:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}

          *클러스터:* {{ .GroupLabels.cluster }}
          *노드:* {{ .GroupLabels.instance }}
          *시간:* {{ .GroupLabels.alertname }}

          *즉시 확인 필요* - 클러스터 가용성에 영향
        send_resolved: true

    email_configs:
      - to: 'frailty-quahog.9e@icloud.com'
        subject: '[P0-CRITICAL] EKS 클러스터 장애: {{ .GroupLabels.alertname }}'
        body: |
          클러스터에서 중대한 장애가 발생했습니다.

          알림: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          시간: {{ .GroupLabels.alertname }}
          클러스터: {{ .GroupLabels.cluster }}

          즉시 대응이 필요합니다.

  # P1: 애플리케이션 크리티컬 (Slack + Email)
  - name: 'application-critical'
    slack_configs:
      - api_url: '{{ .GlobalSlackAPIURL }}'
        channel: '#app-alerts'
        username: 'AlertManager'
        icon_emoji: ':warning:'
        title: '⚠️ [P1-CRITICAL] 핵심 서비스 장애'
        text: >-
          *서비스:* {{ .GroupLabels.service }}
          *알림:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}

          *영향도:* 사용자 서비스에 영향 가능
          *대응:* 15분 이내 확인 필요
        send_resolved: true

    email_configs:
      - to: 'frailty-quahog.9e@icloud.com'
        subject: '[P1-CRITICAL] 서비스 장애: {{ .GroupLabels.service }}'

  # P2: 리소스 경고 (Slack만)
  - name: 'resource-warning'
    slack_configs:
      - api_url: '{{ .GlobalSlackAPIURL }}'
        channel: '#monitoring'
        username: 'AlertManager'
        icon_emoji: ':exclamation:'
        title: '❗ [P2-WARNING] 리소스 임계값 경고'
        text: >-
          *노드:* {{ .GroupLabels.instance }}
          *메트릭:* {{ .GroupLabels.alertname }}
          *현재 값:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}

          *권장:* 30분 이내 확인 및 스케일링 검토
        send_resolved: true

  # P3: 성능 정보 (Slack만, 저빈도)
  - name: 'performance-info'
    slack_configs:
      - api_url: '{{ .GlobalSlackAPIURL }}'
        channel: '#monitoring'
        username: 'AlertManager'
        icon_emoji: ':information_source:'
        title: '💡 [P3-INFO] 성능 모니터링'
        text: >-
          *타입:* {{ .GroupLabels.alertname }}
          *내용:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}

          *참고:* 용량 계획 및 최적화 검토용

# 억제 규칙 (중복 알림 방지)
inhibit_rules:
  # 노드가 다운되면 해당 노드의 다른 모든 알림 억제
  - source_match:
      severity: 'critical'
      alertname: 'NodeDown'
    target_match:
      severity: 'warning'
    equal: ['instance']

  # 클러스터 API 서버 다운 시 다른 모든 알림 억제
  - source_match:
      severity: 'critical'
      alertname: 'KubernetesAPIServerDown'
    target_match_re:
      severity: 'warning|critical'
    equal: ['cluster']

  # 애플리케이션이 완전히 다운된 경우 성능 경고 억제
  - source_match:
      severity: 'critical'
      category: 'application'
    target_match:
      severity: 'warning'
      category: 'performance'
    equal: ['service']
