# AlertManager Configuration for EKS Multi-Service Environment
# ì‹¤ë¬´ ìš´ì˜ì„ ìœ„í•œ ê³„ì¸µì  ì•Œë¦¼ ì„¤ì •

global:
  # SMTP ê¸°ë³¸ ì„¤ì • (ì´ë©”ì¼ ë°œì†¡ìš©)
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@dev-cluster.local'
  smtp_auth_username: 'alerts@dev-cluster.local'
  smtp_auth_password: 'change-me' # Vaultë¡œ ì•”í˜¸í™” í•„ìš”

  # Slack API URL (ì „ì—­ ì„¤ì •)
  slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

# ì•Œë¦¼ ë¼ìš°íŒ… ê·œì¹™
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 5m
  repeat_interval: 2h
  receiver: 'web.hook.default'

  # ê³„ì¸µë³„ ë¼ìš°íŒ… ê·œì¹™
  routes:
    # P0: í´ëŸ¬ìŠ¤í„° ì¸í”„ë¼ ì¥ì•  (ì¦‰ì‹œ ì•Œë¦¼)
    - match:
        severity: critical
        category: infrastructure
      receiver: 'infrastructure-critical'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 5m

    # P1: í•µì‹¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ ì¥ì• 
    - match:
        severity: critical
        category: application
      receiver: 'application-critical'
      group_wait: 30s
      group_interval: 2m
      repeat_interval: 10m

    # P2: ë¦¬ì†ŒìŠ¤ ì„ê³„ê°’ ê²½ê³ 
    - match:
        severity: warning
        category: resource
      receiver: 'resource-warning'
      group_wait: 5m
      group_interval: 10m
      repeat_interval: 1h

    # P3: ì„±ëŠ¥ ë° ìš©ëŸ‰ ì£¼ì˜ì‚¬í•­
    - match:
        severity: info
        category: performance
      receiver: 'performance-info'
      group_wait: 15m
      group_interval: 30m
      repeat_interval: 6h

# ì•Œë¦¼ ìˆ˜ì‹ ì ì„¤ì •
receivers:
  # ê¸°ë³¸ ìˆ˜ì‹ ì (ì›¹í›… ë˜ëŠ” ë¡œê·¸)
  - name: 'web.hook.default'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        send_resolved: true

  # P0: ì¸í”„ë¼ í¬ë¦¬í‹°ì»¬ (SMS + Slack + Email)
  - name: 'infrastructure-critical'
    slack_configs:
      - api_url: '{{ .GlobalSlackAPIURL }}'
        channel: '#ops-critical'
        username: 'AlertManager'
        icon_emoji: ':fire:'
        title: 'ğŸš¨ [P0-CRITICAL] EKS í´ëŸ¬ìŠ¤í„° ì¸í”„ë¼ ì¥ì• '
        text: >-
          *ì•Œë¦¼:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}

          *í´ëŸ¬ìŠ¤í„°:* {{ .GroupLabels.cluster }}
          *ë…¸ë“œ:* {{ .GroupLabels.instance }}
          *ì‹œê°„:* {{ .GroupLabels.alertname }}

          *ì¦‰ì‹œ í™•ì¸ í•„ìš”* - í´ëŸ¬ìŠ¤í„° ê°€ìš©ì„±ì— ì˜í–¥
        send_resolved: true

    email_configs:
      - to: 'frailty-quahog.9e@icloud.com'
        subject: '[P0-CRITICAL] EKS í´ëŸ¬ìŠ¤í„° ì¥ì• : {{ .GroupLabels.alertname }}'
        body: |
          í´ëŸ¬ìŠ¤í„°ì—ì„œ ì¤‘ëŒ€í•œ ì¥ì• ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

          ì•Œë¦¼: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          ì‹œê°„: {{ .GroupLabels.alertname }}
          í´ëŸ¬ìŠ¤í„°: {{ .GroupLabels.cluster }}

          ì¦‰ì‹œ ëŒ€ì‘ì´ í•„ìš”í•©ë‹ˆë‹¤.

  # P1: ì• í”Œë¦¬ì¼€ì´ì…˜ í¬ë¦¬í‹°ì»¬ (Slack + Email)
  - name: 'application-critical'
    slack_configs:
      - api_url: '{{ .GlobalSlackAPIURL }}'
        channel: '#app-alerts'
        username: 'AlertManager'
        icon_emoji: ':warning:'
        title: 'âš ï¸ [P1-CRITICAL] í•µì‹¬ ì„œë¹„ìŠ¤ ì¥ì• '
        text: >-
          *ì„œë¹„ìŠ¤:* {{ .GroupLabels.service }}
          *ì•Œë¦¼:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}

          *ì˜í–¥ë„:* ì‚¬ìš©ì ì„œë¹„ìŠ¤ì— ì˜í–¥ ê°€ëŠ¥
          *ëŒ€ì‘:* 15ë¶„ ì´ë‚´ í™•ì¸ í•„ìš”
        send_resolved: true

    email_configs:
      - to: 'frailty-quahog.9e@icloud.com'
        subject: '[P1-CRITICAL] ì„œë¹„ìŠ¤ ì¥ì• : {{ .GroupLabels.service }}'

  # P2: ë¦¬ì†ŒìŠ¤ ê²½ê³  (Slackë§Œ)
  - name: 'resource-warning'
    slack_configs:
      - api_url: '{{ .GlobalSlackAPIURL }}'
        channel: '#monitoring'
        username: 'AlertManager'
        icon_emoji: ':exclamation:'
        title: 'â— [P2-WARNING] ë¦¬ì†ŒìŠ¤ ì„ê³„ê°’ ê²½ê³ '
        text: >-
          *ë…¸ë“œ:* {{ .GroupLabels.instance }}
          *ë©”íŠ¸ë¦­:* {{ .GroupLabels.alertname }}
          *í˜„ì¬ ê°’:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}

          *ê¶Œì¥:* 30ë¶„ ì´ë‚´ í™•ì¸ ë° ìŠ¤ì¼€ì¼ë§ ê²€í† 
        send_resolved: true

  # P3: ì„±ëŠ¥ ì •ë³´ (Slackë§Œ, ì €ë¹ˆë„)
  - name: 'performance-info'
    slack_configs:
      - api_url: '{{ .GlobalSlackAPIURL }}'
        channel: '#monitoring'
        username: 'AlertManager'
        icon_emoji: ':information_source:'
        title: 'ğŸ’¡ [P3-INFO] ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§'
        text: >-
          *íƒ€ì…:* {{ .GroupLabels.alertname }}
          *ë‚´ìš©:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}

          *ì°¸ê³ :* ìš©ëŸ‰ ê³„íš ë° ìµœì í™” ê²€í† ìš©

# ì–µì œ ê·œì¹™ (ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€)
inhibit_rules:
  # ë…¸ë“œê°€ ë‹¤ìš´ë˜ë©´ í•´ë‹¹ ë…¸ë“œì˜ ë‹¤ë¥¸ ëª¨ë“  ì•Œë¦¼ ì–µì œ
  - source_match:
      severity: 'critical'
      alertname: 'NodeDown'
    target_match:
      severity: 'warning'
    equal: ['instance']

  # í´ëŸ¬ìŠ¤í„° API ì„œë²„ ë‹¤ìš´ ì‹œ ë‹¤ë¥¸ ëª¨ë“  ì•Œë¦¼ ì–µì œ
  - source_match:
      severity: 'critical'
      alertname: 'KubernetesAPIServerDown'
    target_match_re:
      severity: 'warning|critical'
    equal: ['cluster']

  # ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì™„ì „íˆ ë‹¤ìš´ëœ ê²½ìš° ì„±ëŠ¥ ê²½ê³  ì–µì œ
  - source_match:
      severity: 'critical'
      category: 'application'
    target_match:
      severity: 'warning'
      category: 'performance'
    equal: ['service']
