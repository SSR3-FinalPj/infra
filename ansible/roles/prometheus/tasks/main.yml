---
# roles/prometheus/tasks/main.yml

- name: Check if Helm is installed
  command: helm version --short
  register: helm_version
  failed_when: false
  changed_when: false

- name: Ensure Helm is available
  fail:
    msg: 'Helm is not installed or not accessible. Please install Helm first.'
  when: helm_version.rc != 0

- name: Add Prometheus Community Helm repository
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: https://prometheus-community.github.io/helm-charts
    state: present
  register: helm_repo_result

- name: Update Helm repositories
  command: helm repo update
  when: helm_repo_result.changed
  changed_when: true

- name: Check if monitoring stack is already installed
  command: helm list -n '{{ dev_namespace }}' -f monitoring
  register: helm_list_result
  changed_when: false
  failed_when: false

- name: Check monitoring release status for any in-progress state
  command: helm status monitoring -n '{{ dev_namespace }}'
  register: helm_status_result
  changed_when: false
  failed_when: false
  # helm list ê²°ê³¼ì™€ ê´€ê³„ì—†ì´ monitoring ë¦´ë¦¬ìŠ¤ê°€ ì¡´ì¬í•˜ë©´ ë¬´ì¡°ê±´ ìƒíƒœë¥¼ í™•ì¸í•˜ë„ë¡ ë³€ê²½
  when: "'monitoring' in helm_list_result.stdout"

- name: Force rollback for any stuck states
  command: helm rollback monitoring -n '{{ dev_namespace }}' --wait --timeout 300s
  when:
    - "'monitoring' in helm_list_result.stdout"
    - helm_status_result.rc != 0 or 'pending' in helm_status_result.stdout or 'failed' in helm_status_result.stdout
  ignore_errors: true

- name: Force delete stuck Helm secrets if rollback fails
  kubernetes.core.k8s:
    api_version: v1
    kind: Secret
    namespace: '{{ dev_namespace }}'
    state: absent
    label_selectors:
      - 'owner=helm'
      - 'name=monitoring'
  ignore_errors: true
  when:
    - "'monitoring' in helm_list_result.stdout"
    # rollback íƒœìŠ¤í¬ê°€ ì‹¤íŒ¨í–ˆì„ ê²½ìš°ì—ë§Œ ì‹¤í–‰í•˜ë„ë¡ ì¡°ê±´ ì¶”ê°€

- name: Wait after cleanup
  pause:
    seconds: 15
  when:
    - "'monitoring' in helm_list_result.stdout"

- name: Handle stuck pending-upgrade state
  command: helm rollback monitoring 1 -n '{{ dev_namespace }}'
  when:
    - "'monitoring' in helm_list_result.stdout"
    - helm_status_result.rc == 0
    - "'pending-upgrade' in helm_status_result.stdout"
  ignore_errors: true

- name: Wait for rollback to complete
  pause:
    seconds: 10
  when:
    - "'monitoring' in helm_list_result.stdout"
    - helm_status_result.rc == 0
    - "'pending-upgrade' in helm_status_result.stdout"

- name: Force delete stuck Helm secrets (if still in progress)
  kubernetes.core.k8s:
    api_version: v1
    kind: Secret
    namespace: '{{ dev_namespace }}'
    state: absent
    label_selectors:
      - 'owner=helm'
      - 'name=monitoring'
      - 'status=pending-upgrade'
  ignore_errors: true
  when:
    - "'monitoring' in helm_list_result.stdout"

- name: Wait after force cleanup
  pause:
    seconds: 5
  when:
    - "'monitoring' in helm_list_result.stdout"

- name: Remove existing standalone Grafana (if exists)
  kubernetes.core.k8s:
    api_version: apps/v1
    kind: Deployment
    name: grafana
    namespace: '{{ dev_namespace }}'
    state: absent
  when: "'monitoring' not in helm_list_result.stdout"

- name: Remove existing Grafana service (if exists)
  kubernetes.core.k8s:
    api_version: v1
    kind: Service
    name: grafana
    namespace: '{{ dev_namespace }}'
    state: absent
  when: "'monitoring' not in helm_list_result.stdout"

- name: Deploy Prometheus Stack using Helm
  kubernetes.core.helm:
    name: monitoring
    chart_ref: prometheus-community/kube-prometheus-stack
    release_namespace: '{{ dev_namespace }}'
    create_namespace: true
    values_files:
      - '{{ role_path }}/templates/values.yaml'
    wait: true
    wait_timeout: 600s
    atomic: true
    state: present

- name: Deploy custom ServiceMonitors for existing services
  kubernetes.core.k8s:
    state: present
    src: 'templates/servicemonitors.yaml'
    namespace: '{{ dev_namespace }}'

- name: Create ConfigMap for custom EKS dashboard
  shell: |
    kubectl create configmap eks-nodes-monitoring-dashboard \
      --from-file={{ role_path }}/templates/grafana-dashboards/eks-nodes-monitoring.json \
      --namespace='{{ dev_namespace }}' \
      --dry-run=client -o yaml | \
      sed 's/eks-nodes-monitoring\.json/eks-nodes-monitoring.json/' | \
      kubectl apply -f -
    kubectl label configmap eks-nodes-monitoring-dashboard \
      grafana_dashboard=1 grafana_folder="Kubernetes-Monitoring" \
      --namespace='{{ dev_namespace }}' --overwrite
  ignore_errors: true

- name: Create ConfigMap for custom Application dashboard
  shell: |
    kubectl create configmap application-overview-dashboard \
      --from-file={{ role_path }}/templates/grafana-dashboards/application-overview.json \
      --namespace='{{ dev_namespace }}' \
      --dry-run=client -o yaml | \
      sed 's/application-overview\.json/application-overview.json/' | \
      kubectl apply -f -
    kubectl label configmap application-overview-dashboard \
      grafana_dashboard=1 grafana_folder="Application-Monitoring" \
      --namespace='{{ dev_namespace }}' --overwrite
  ignore_errors: true

- name: Create ConfigMap for k6 prometheus dashboard
  shell: |
    kubectl create configmap k6-prometheus-dashboard \
      --from-file={{ role_path }}/templates/grafana-dashboards/k6-prometheus.json \
      --namespace='{{ dev_namespace }}' \
      --dry-run=client -o yaml | \
      sed 's/k6-prometheus\.json/k6-prometheus.json/' | \
      kubectl apply -f -
    kubectl label configmap k6-prometheus-dashboard \
      grafana_dashboard=1 grafana_folder="K6-Monitoring" \
      --namespace='{{ dev_namespace }}' --overwrite
  ignore_errors: true

- name: Display monitoring access information
  debug:
    msg:
      - 'Prometheus Stack deployed successfully!'
      - 'âœ… ì»¤ë®¤ë‹ˆí‹° ëŒ€ì‹œë³´ë“œ: Node Exporter, Kubernetes Cluster, Redis, PostgreSQL'
      - 'âœ… ì»¤ìŠ¤í…€ ëŒ€ì‹œë³´ë“œ: EKS ë…¸ë“œ ëª¨ë‹ˆí„°ë§, ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œìš”'
      - 'ğŸ“Š Grafana: ALB Internal Ingressë¥¼ í†µí•´ ì ‘ê·¼ (admin/grafana163)'
      - "ğŸ” Prometheus: http://monitoring-kube-prometheus-prometheus.'{{ dev_namespace }}':9090"
      - "âš ï¸ AlertManager: http://monitoring-kube-prometheus-alertmanager.'{{ dev_namespace }}':9093"
      - ''
      - 'ğŸ¯ ëŒ€ì‹œë³´ë“œ ìœ„ì¹˜:'
      - '   - Kubernetes-Monitoring í´ë”: EKS ë…¸ë“œ ëª¨ë‹ˆí„°ë§, Node Exporter'
      - '   - Application-Monitoring í´ë”: ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œìš”, Redis, PostgreSQL'
      - ''
      - 'ğŸš¨ AlertManager ì„¤ì •:'
      - '   - ì‹¤ë¬´ ì¤‘ì‹¬ 4ë‹¨ê³„ ì•Œë¦¼ ìš°ì„ ìˆœìœ„ (P0~P3) êµ¬ì„±'
      - '   - Slack ì±„ë„ë³„ ì•Œë¦¼ ë¶„ë¥˜ (#ops-critical, #app-alerts, #monitoring)'
      - '   - ì§€ëŠ¥í˜• ì–µì œ ê·œì¹™ìœ¼ë¡œ ì•Œë¦¼ í”¼ë¡œë„ ë°©ì§€'
      - '   - EKS íŠ¹í™” ì•Œë¦¼: ë…¸ë“œ ë‹¤ìš´, Pod í¬ë˜ì‹œ, VPC CNI ì—ëŸ¬'
      - '   âš™ï¸ ì„¤ì • ë°©ë²•: ansible/roles/prometheus/templates/alertmanager-guide.md ì°¸ê³ '
      - '   ğŸ” ì ‘ê·¼: ALB Internal Ingress â†’ AlertManager UI'
