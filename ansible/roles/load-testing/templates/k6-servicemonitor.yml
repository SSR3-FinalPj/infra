---
# k6 ServiceMonitor for Prometheus
# k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë©”íŠ¸ë¦­ì„ Prometheusì—ì„œ ìë™ ìˆ˜ì§‘

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: k6-load-test-monitor
  labels:
    app: k6-load-test
    component: monitoring
spec:
  selector:
    matchLabels:
      app: k6-load-test
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
      honorLabels: true
      # k6 ë©”íŠ¸ë¦­ íŠ¹í™” ì„¤ì •
      metricRelabelings:
        - sourceLabels: [__name__]
          regex: 'k6_.*'
          targetLabel: __tmp_k6_metric
          replacement: 'true'
        # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¼ë²¨ ì¶”ê°€
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: kubernetes_namespace
        # Pod ì´ë¦„ ë¼ë²¨ ì¶”ê°€
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: kubernetes_pod_name
        # í…ŒìŠ¤íŠ¸ íƒ€ì… ë¼ë²¨ ì¶”ê°€
        - sourceLabels: [__meta_kubernetes_pod_label_test_type]
          targetLabel: test_type
          regex: (.+)
          replacement: '${1}'

---
# k6 í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ìœ„í•œ PrometheusRule
# ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê´€ë ¨ ì•Œë¦¼ ê·œì¹™ ì •ì˜
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: k6-load-test-rules
  labels:
    app: k6-load-test
    component: monitoring
spec:
  groups:
    - name: k6-load-test.rules
      interval: 30s
      rules:
        # k6 í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
        - alert: K6LoadTestRunning
          expr: k6_vus > 0
          for: 1m
          labels:
            severity: info
            category: load-test
          annotations:
            summary: 'k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤'
            description: 'í…ŒìŠ¤íŠ¸ {{ $labels.testid }}ê°€ {{ $value }}ëª…ì˜ ê°€ìƒ ì‚¬ìš©ìë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.'

        # ì‘ë‹µì‹œê°„ ì„ê³„ê°’ ì´ˆê³¼
        - alert: K6HighResponseTime
          expr: k6_http_req_duration{quantile="0.95"} > 500
          for: 2m
          labels:
            severity: warning
            category: performance
          annotations:
            summary: 'ì‘ë‹µì‹œê°„ì´ ì„ê³„ê°’ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤'
            description: '95%ile ì‘ë‹µì‹œê°„ì´ {{ $value }}msë¡œ 500msë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.'

        # ì—ëŸ¬ìœ¨ ì„ê³„ê°’ ì´ˆê³¼
        - alert: K6HighErrorRate
          expr: (k6_http_req_failed / k6_http_reqs) * 100 > 5
          for: 1m
          labels:
            severity: critical
            category: reliability
          annotations:
            summary: 'ì—ëŸ¬ìœ¨ì´ ì„ê³„ê°’ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤'
            description: 'ì—ëŸ¬ìœ¨ì´ {{ $value }}%ë¡œ 5%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.'

        # ì²˜ë¦¬ëŸ‰ ê¸‰ê° ê°ì§€
        - alert: K6LowThroughput
          expr: rate(k6_http_reqs[1m]) < 10
          for: 2m
          labels:
            severity: warning
            category: performance
          annotations:
            summary: 'ì²˜ë¦¬ëŸ‰ì´ ë‚®ìŠµë‹ˆë‹¤'
            description: 'ì´ˆë‹¹ ìš”ì²­ ìˆ˜ê°€ {{ $value }}ë¡œ ì˜ˆìƒì¹˜ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤.'

---
# Grafana Dashboardìš© ConfigMap
# k6 í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì‹œê°í™”í•˜ëŠ” ëŒ€ì‹œë³´ë“œ
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-dashboard-config
  labels:
    grafana_dashboard: '1'
    grafana_folder: 'Load-Testing'
data:
  k6-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "ğŸš€ k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ",
        "tags": ["k6", "load-testing", "performance"],
        "timezone": "browser",
        "panels": [
          {
            "title": "ğŸ“Š í…ŒìŠ¤íŠ¸ ê°œìš”",
            "type": "stat",
            "targets": [
              {
                "expr": "k6_vus",
                "legendFormat": "í˜„ì¬ ê°€ìƒ ì‚¬ìš©ì ìˆ˜"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 50},
                    {"color": "red", "value": 100}
                  ]
                }
              }
            }
          },
          {
            "title": "ğŸ“ˆ ì´ˆë‹¹ ìš”ì²­ ìˆ˜ (RPS)",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(k6_http_reqs[1m])",
                "legendFormat": "RPS"
              }
            ],
            "yAxes": [
              {
                "label": "Requests/sec",
                "min": 0
              }
            ]
          },
          {
            "title": "â±ï¸ ì‘ë‹µ ì‹œê°„ ë¶„í¬",
            "type": "graph", 
            "targets": [
              {
                "expr": "k6_http_req_duration{quantile=\"0.50\"}",
                "legendFormat": "50%ile"
              },
              {
                "expr": "k6_http_req_duration{quantile=\"0.95\"}",
                "legendFormat": "95%ile"
              },
              {
                "expr": "k6_http_req_duration{quantile=\"0.99\"}",
                "legendFormat": "99%ile"
              }
            ],
            "yAxes": [
              {
                "label": "Response Time (ms)",
                "min": 0
              }
            ]
          },
          {
            "title": "âŒ ì—ëŸ¬ìœ¨",
            "type": "graph",
            "targets": [
              {
                "expr": "(rate(k6_http_req_failed[1m]) / rate(k6_http_reqs[1m])) * 100",
                "legendFormat": "ì—ëŸ¬ìœ¨ (%)"
              }
            ],
            "yAxes": [
              {
                "label": "Error Rate (%)",
                "min": 0,
                "max": 100
              }
            ],
            "alert": {
              "conditions": [
                {
                  "query": {"params": ["A", "1m", "now"]},
                  "reducer": {"params": [], "type": "last"},
                  "evaluator": {"params": [5], "type": "gt"}
                }
              ],
              "name": "High Error Rate"
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "10s"
      }
    }
