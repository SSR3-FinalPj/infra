---
# Load Testing Role with k6
# í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ

- name: Clean up existing k6 Jobs before deployment
  kubernetes.core.k8s:
    state: absent
    api_version: batch/v1
    kind: Job
    namespace: '{{ dev_namespace }}'
    label_selectors:
      - app=k6-load-test
  ignore_errors: true

- name: Wait for Job cleanup to complete
  pause:
    seconds: 5

- name: Create k6 test scripts ConfigMap
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: k6-test-scripts
        namespace: '{{ dev_namespace }}'
      data:
        basic-load-test.js: |
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          import { Counter, Rate, Trend } from 'k6/metrics';

          // ì»¤ìŠ¤í…€ ë©”íŠ¸ë¦­ ì •ì˜ (Prometheus ì—°ë™)
          const customErrorRate = new Rate('custom_error_rate');
          const customResponseTime = new Trend('custom_response_time');
          const apiCalls = new Counter('api_calls_total');

          export let options = {
            scenarios: {
              // ê¸°ë³¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ì ì§„ì  ì¦ê°€
              ramp_up_test: {
                executor: 'ramping-vus',
                startVUs: 1,
                stages: [
                  { duration: '2m', target: 10 },   // 2ë¶„ ë™ì•ˆ 10ëª…ê¹Œì§€ ì¦ê°€
                  { duration: '5m', target: 10 },   // 5ë¶„ ë™ì•ˆ 10ëª… ìœ ì§€
                  { duration: '2m', target: 50 },   // 2ë¶„ ë™ì•ˆ 50ëª…ê¹Œì§€ ì¦ê°€
                  { duration: '5m', target: 50 },   // 5ë¶„ ë™ì•ˆ 50ëª… ìœ ì§€
                  { duration: '2m', target: 0 },    // 2ë¶„ ë™ì•ˆ 0ëª…ê¹Œì§€ ê°ì†Œ
                ],
                gracefulRampDown: '30s',
              }
            },
            thresholds: {
              http_req_duration: ['p(95)<200'],        // 95%ê°€ 200ms ë¯¸ë§Œ
              http_req_failed: ['rate<0.01'],          // ì—ëŸ¬ìœ¨ 1% ë¯¸ë§Œ
              http_reqs: ['rate>10'],                  // ì´ˆë‹¹ 10 ìš”ì²­ ì´ìƒ
            }
          };

          export default function () {
            const baseUrl = `http://backend.dev-system.svc.cluster.local:8080`;
            
            // API í˜¸ì¶œ ì‹œë‚˜ë¦¬ì˜¤ë“¤
            const scenarios = [
              { name: 'health-check', url: `${baseUrl}/actuator/health`, weight: 30 },
              { name: 'api-info', url: `${baseUrl}/actuator/info`, weight: 20 },
              { name: 'metrics', url: `${baseUrl}/actuator/metrics`, weight: 15 },
            ];
            
            // ê°€ì¤‘ì¹˜ ê¸°ë°˜ ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ
            const random = Math.random() * 100;
            let cumulativeWeight = 0;
            let selectedScenario = scenarios[0];
            
            for (let scenario of scenarios) {
              cumulativeWeight += scenario.weight;
              if (random <= cumulativeWeight) {
                selectedScenario = scenario;
                break;
              }
            }
            
            // HTTP ìš”ì²­ ì‹¤í–‰
            const response = http.get(selectedScenario.url, {
              headers: {
                'User-Agent': 'k6-load-test',
                'Accept': 'application/json',
              },
            });
            
            // ì‘ë‹µ ê²€ì¦
            const success = check(response, {
              'status is 200': (r) => r.status === 200,
              'response time < 500ms': (r) => r.timings.duration < 500,
              'response has body': (r) => r.body.length > 0,
            });
            
            // ì»¤ìŠ¤í…€ ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
            customErrorRate.add(!success);
            customResponseTime.add(response.timings.duration);
            apiCalls.add(1, { endpoint: selectedScenario.name });
            
            sleep(1);
          }

        stress-test.js: |
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export let options = {
            scenarios: {
              // ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸: ê¸‰ê²©í•œ ë¶€í•˜ ì¦ê°€
              stress_test: {
                executor: 'ramping-vus',
                startVUs: 1,
                stages: [
                  { duration: '1m', target: 50 },    // 1ë¶„ ë™ì•ˆ 50ëª…
                  { duration: '3m', target: 100 },   // 3ë¶„ ë™ì•ˆ 100ëª…
                  { duration: '3m', target: 200 },   // 3ë¶„ ë™ì•ˆ 200ëª… (ìŠ¤íŠ¸ë ˆìŠ¤)
                  { duration: '1m', target: 0 },     // 1ë¶„ ë™ì•ˆ ê°ì†Œ
                ],
                gracefulRampDown: '30s',
              }
            },
            thresholds: {
              http_req_duration: ['p(95)<1000'],       // ìŠ¤íŠ¸ë ˆìŠ¤ ìƒí™©ì—ì„œ 1ì´ˆ ë¯¸ë§Œ
              http_req_failed: ['rate<0.05'],          // ì—ëŸ¬ìœ¨ 5% ë¯¸ë§Œ
            }
          };

          export default function () {
            const response = http.get('http://backend.dev-system.svc.cluster.local:8080/actuator/health');
            check(response, {
              'status is 200': (r) => r.status === 200,
              'response time acceptable': (r) => r.timings.duration < 2000,
            });
            sleep(0.5);  // ë” ë†’ì€ ë¶€í•˜ë¥¼ ìœ„í•´ ì§§ì€ ëŒ€ê¸°
          }

        spike-test.js: |
          import http from 'k6/http';
          import { check } from 'k6';

          export let options = {
            scenarios: {
              // ìŠ¤íŒŒì´í¬ í…ŒìŠ¤íŠ¸: ê°‘ì‘ìŠ¤ëŸ° íŠ¸ë˜í”½ ê¸‰ì¦
              spike_test: {
                executor: 'ramping-vus',
                startVUs: 1,
                stages: [
                  { duration: '30s', target: 10 },    // í‰ìƒì‹œ ë¶€í•˜
                  { duration: '30s', target: 500 },   // ê¸‰ê²©í•œ ì¦ê°€ (ìŠ¤íŒŒì´í¬)
                  { duration: '2m', target: 500 },    // ìŠ¤íŒŒì´í¬ ìœ ì§€
                  { duration: '30s', target: 10 },    // í‰ìƒì‹œë¡œ ë³µê·€
                  { duration: '1m', target: 0 },      // ì¢…ë£Œ
                ],
                gracefulRampDown: '30s',
              }
            },
            thresholds: {
              http_req_failed: ['rate<0.1'],           // ìŠ¤íŒŒì´í¬ ì‹œ ì—ëŸ¬ìœ¨ 10% ë¯¸ë§Œ
            }
          };

          export default function () {
            const response = http.get('http://backend.dev-system.svc.cluster.local:8080/actuator/health');
            check(response, {
              'status is not 500': (r) => r.status !== 500,  // ì„œë²„ ì—ëŸ¬ê°€ ì•„ë‹˜
            });
          }

        endurance-test.js: |
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export let options = {
            scenarios: {
              // ë‚´êµ¬ì„± í…ŒìŠ¤íŠ¸: ì¥ì‹œê°„ ì§€ì†
              endurance_test: {
                executor: 'constant-vus',
                vus: 20,                             // ì¼ì •í•œ 20ëª… ì‚¬ìš©ì
                duration: '30m',                     // 30ë¶„ê°„ ì§€ì†
              }
            },
            thresholds: {
              http_req_duration: ['p(95)<300'],       // ì¼ê´€ëœ ì„±ëŠ¥ ìœ ì§€
              http_req_failed: ['rate<0.02'],         // ì•ˆì •ì ì¸ ì—ëŸ¬ìœ¨
            }
          };

          export default function () {
            const response = http.get('http://backend.dev-system.svc.cluster.local:8080/actuator/health');
            check(response, {
              'status is 200': (r) => r.status === 200,
              'consistent performance': (r) => r.timings.duration < 500,
            });
            sleep(2);  // ì ë‹¹í•œ ê°„ê²©ìœ¼ë¡œ ìš”ì²­
          }
    state: present

- name: Create k6 RBAC
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: k6-runner
        namespace: '{{ dev_namespace }}'
    state: present

- name: Create k6 Service for metrics
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: k6-metrics-service
        namespace: '{{ dev_namespace }}'
        labels:
          app: k6-load-test
        annotations:
          prometheus.io/scrape: "true"
          prometheus.io/port: "6565"
          prometheus.io/path: "/metrics"
      spec:
        ports:
        - name: metrics
          port: 6565
          targetPort: 6565
          protocol: TCP
        selector:
          app: k6-load-test
    state: present

- name: Deploy k6 Job templates
  kubernetes.core.k8s:
    state: present
    src: 'templates/k6-jobs.yml'
    namespace: '{{ dev_namespace }}'

- name: Deploy k6 ServiceMonitor and PrometheusRules
  kubernetes.core.k8s:
    state: present
    src: 'templates/k6-servicemonitor.yml'
    namespace: '{{ dev_namespace }}'

- name: Create load testing documentation
  copy:
    dest: /tmp/load-testing-usage.md
    content: |
      # ğŸš€ k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‚¬ìš©ë²•

      ## ê¸°ë³¸ ì‹¤í–‰ ëª…ë ¹ì–´

      ```bash
      # ê¸°ë³¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      kubectl create job manual-basic-test --from=cronjob/k6-daily-performance-test -n dev-system

      # ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      kubectl create job manual-stress-test --from=cronjob/k6-weekly-stress-test -n dev-system

      # í…ŒìŠ¤íŠ¸ ë¡œê·¸ í™•ì¸
      kubectl logs -f job/manual-basic-test -n dev-system

      # ì‹¤í–‰ ì¤‘ì¸ í…ŒìŠ¤íŠ¸ í™•ì¸
      kubectl get jobs -n dev-system | grep k6

      # í…ŒìŠ¤íŠ¸ ì •ë¦¬
      kubectl delete job manual-basic-test -n dev-system
      ```

      ## Grafana ëŒ€ì‹œë³´ë“œ ì ‘ê·¼
      1. Grafana ì ‘ì† (ALB Internal Ingress í†µí•´)
      2. "Load-Testing" í´ë” â†’ "k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ" ì„ íƒ
      3. ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëª¨ë‹ˆí„°ë§

      ## ì •ê¸° ì‹¤í–‰ ìŠ¤ì¼€ì¤„
      - ë§¤ì¼ ì˜¤ì „ 2ì‹œ: ê¸°ë³¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
      - ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 3ì‹œ: ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸

- name: Display load testing information
  debug:
    msg:
      - 'Load Testing ì‹œìŠ¤í…œì´ êµ¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!'
      - 'ğŸ“Š k6 ê¸°ë°˜ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ ë¶€í•˜ í…ŒìŠ¤íŠ¸'
      - 'ğŸ¯ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:'
      - '   - basic-load-test.js: ê¸°ë³¸ ì„±ëŠ¥ (ì ì§„ì  ì¦ê°€, 16ë¶„)'
      - '   - stress-test.js: ìŠ¤íŠ¸ë ˆìŠ¤ (ê³ ë¶€í•˜, 8ë¶„)'  
      - '   - spike-test.js: ìŠ¤íŒŒì´í¬ (ê¸‰ì¦, 4ë¶„)'
      - '   - endurance-test.js: ë‚´êµ¬ì„± (30ë¶„ ì§€ì†)'
      - ''
      - 'ğŸš€ ìˆ˜ë™ ì‹¤í–‰:'
      - '   kubectl create job test-run --from=cronjob/k6-daily-performance-test -n {{ dev_namespace }}'
      - '   kubectl logs -f job/test-run -n {{ dev_namespace }}'
      - ''
      - 'ğŸ“… ìë™ ì‹¤í–‰:'
      - '   - ë§¤ì¼ ì˜¤ì „ 2ì‹œ: ê¸°ë³¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸'
      - '   - ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 3ì‹œ: ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸'
      - ''
      - 'ğŸ“ˆ ëª¨ë‹ˆí„°ë§:'
      - '   - Prometheus: k6 ë©”íŠ¸ë¦­ ìë™ ìˆ˜ì§‘ ({{ dev_namespace }} ë„¤ì„ìŠ¤í˜ì´ìŠ¤)'
      - '   - Grafana: "Load-Testing" í´ë”ì—ì„œ ëŒ€ì‹œë³´ë“œ í™•ì¸'
      - '   - AlertManager: ì„±ëŠ¥ ì„ê³„ê°’ ì´ˆê³¼ ì‹œ ì•Œë¦¼'
      - '   ğŸ”§ ê´€ë¦¬ í¸ì˜ì„±: ëª¨ë“  ê°œë°œ ë¦¬ì†ŒìŠ¤ë¥¼ {{ dev_namespace }}ë¡œ í†µí•© ê´€ë¦¬'
      - '   ğŸ’° ë¹„ìš© ì ˆì•½: í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ ì‹¤í–‰ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ë¹„ìš© $0'