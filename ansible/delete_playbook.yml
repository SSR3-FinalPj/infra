---
- hosts: localhost
  gather_facts: no
  tasks:
    - name: 'Delete Portainer resources'
      kubernetes.core.k8s:
        state: absent
        src: '{{ item }}'
        namespace: '{{ dev_namespace }}'
      loop:
        - 'roles/portainer/templates/portainer.yaml'

    - name: 'Delete Prometheus resources'
      kubernetes.core.k8s:
        state: absent
        src: 'roles/prometheus/templates/servicemonitors.yaml'
        namespace: '{{ dev_namespace }}'

    - name: 'Delete Elastic-HQ resources'
      kubernetes.core.k8s:
        state: absent
        src: 'roles/elastic-hq/templates/elastic-hq.yaml'
        namespace: '{{ dev_namespace }}'

    - name: 'Delete Kibana resources'
      kubernetes.core.k8s:
        state: absent
        src: '{{ item }}'
        namespace: '{{ dev_namespace }}'
      loop:
        - 'roles/kibana/templates/kibana.yaml'
        - 'roles/kibana/templates/kibana-configmap.yaml'

    - name: 'Delete Elasticsearch resources'
      kubernetes.core.k8s:
        state: absent
        src: '{{ item }}'
        namespace: '{{ dev_namespace }}'
      loop:
        - 'roles/elasticsearch/templates/es-master.yaml'
        - 'roles/elasticsearch/templates/es-master-cs.yaml'
        - 'roles/elasticsearch/templates/es-master-configmap.yaml'
        - 'roles/elasticsearch/templates/es-data1.yaml'
        - 'roles/elasticsearch/templates/es-data1-cs.yaml'
        - 'roles/elasticsearch/templates/es-data1-configmap.yaml'
        - 'roles/elasticsearch/templates/es-data2.yaml'
        - 'roles/elasticsearch/templates/es-data2-cs.yaml'
        - 'roles/elasticsearch/templates/es-data2-configmap.yaml'

    - name: 'Delete Redis resources'
      kubernetes.core.k8s:
        state: absent
        src: '{{ item }}'
        namespace: '{{ dev_namespace }}'
      loop:
        - 'roles/redis/templates/redis-sentinel-service.yaml'
        - 'roles/redis/templates/redis-sentinel-controller.yaml'
        - 'roles/redis/templates/redis-master.yaml'
        - 'roles/redis/templates/redis-master-cs.yaml'
        - 'roles/redis/templates/redis-controller.yaml'
        - 'roles/redis/templates/redis-pvc.yaml'

    - name: 'Delete Adminer resources'
      kubernetes.core.k8s:
        state: absent
        src: '{{ item }}'
        namespace: '{{ dev_namespace }}'
      loop:
        - 'roles/adminer/templates/adminer.yaml'
        - 'roles/adminer/templates/adminer-configmap.yaml'

    # - name: "Delete Airflow resources"
    #   kubernetes.core.k8s:
    #     state: absent
    #     src: "{{ item }}"
    #     namespace: '{{ dev_namespace }}'
    #   loop:
    #     - "roles/airflow/templates/token_updater_deployment.yaml.j2"
    #     - "roles/airflow/templates/pod_template.yaml.j2"
    #     - "roles/airflow/templates/api_service_secrets.yaml.j2"
    #     - "roles/airflow/templates/airflow_service.yaml.j2"
    #     - "roles/airflow/templates/airflow_service_rbac.yaml.j2"
    #     - "roles/airflow/templates/airflow_service_init.yaml.j2"

    - name: 'Delete PostgreSQL resources'
      kubernetes.core.k8s:
        state: absent
        src: 'roles/postgresql/templates/postgresql.yaml'
        namespace: '{{ dev_namespace }}'

    - name: 'Delete Kafka resources'
      kubernetes.core.k8s:
        state: absent
        src: '{{ item }}'
        namespace: '{{ dev_namespace }}'
      loop:
        - 'roles/kafka/templates/kafka-ui.yaml'
        - 'roles/kafka/templates/kafka.yaml'
        - 'roles/kafka/templates/kafka-cs.yaml'
        - 'roles/kafka/templates/kafka-pdb.yaml'

    - name: 'Delete Zookeeper resources'
      kubernetes.core.k8s:
        state: absent
        src: '{{ item }}'
        namespace: '{{ dev_namespace }}'
      loop:
        - 'roles/zookeeper/templates/zk.yaml'
        - 'roles/zookeeper/templates/zk-svc.yaml'
        - 'roles/zookeeper/templates/zk-pdb.yaml'
        - 'roles/zookeeper/templates/zk-configmap.yaml'

    - name: 'Delete Ingress resources'
      kubernetes.core.k8s:
        state: absent
        definition: "{{ lookup('template', item) }}"
      loop:
        - 'roles/ingress/templates/http_test.yaml.j2'
        - 'roles/ingress/templates/alb_internal_ingress.yaml.j2'
        - 'roles/ingress/templates/alb_external_ingress.yaml.j2'

    - name: 'Delete Storage resources'
      kubernetes.core.k8s:
        state: absent
        src: '{{ item }}'
        namespace: '{{ dev_namespace }}'
      loop:
        - 'roles/storage/templates/storageClass.yaml'
        - 'roles/storage/templates/createpv.yaml.j2'

    - name: 'Delete ALB Controller resources'
      block:
        - name: Delete IngressClass
          kubernetes.core.k8s:
            state: absent
            definition: "{{ lookup('template', 'roles/alb-controller/templates/ingress-class.yaml.j2') }}"

        - name: Uninstall AWS Load Balancer Controller Helm chart
          kubernetes.core.helm:
            name: aws-load-balancer-controller
            state: absent
            release_namespace: kube-system

        - name: Uninstall Cert-Manager Helm chart
          kubernetes.core.helm:
            name: cert-manager
            state: absent
            release_namespace: cert-manager

        - name: Remove the EKS Helm chart repository
          kubernetes.core.helm_repository:
            name: aws
            state: absent

        - name: Remove the Jetstack Helm repository
          kubernetes.core.helm_repository:
            name: jetstack
            state: absent
    - name: 'Delete CSI Drivers resources'
      block:
        - name: Uninstall AWS EFS CSI Driver Helm chart
          kubernetes.core.helm:
            name: aws-efs-csi-driver
            state: absent
            release_namespace: kube-system

        - name: Uninstall AWS EBS CSI Driver Helm chart
          kubernetes.core.helm:
            name: aws-ebs-csi-driver
            state: absent
            release_namespace: kube-system

        - name: Remove the aws-efs-csi-driver Helm repository
          kubernetes.core.helm_repository:
            name: aws-efs-csi-driver
            state: absent

        - name: Remove the aws-ebs-csi-driver Helm repository
          kubernetes.core.helm_repository:
            name: aws-ebs-csi-driver
            state: absent
